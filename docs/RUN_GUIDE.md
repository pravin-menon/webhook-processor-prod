# Webhook Processor - Complete Run Guide

This comprehensive guide walks you through setting up, configuring, and running the Webhook Processor in both development and production environments.

## 🎯 Overview

The Webhook Processor is a cloud-native application designed to:
- Receive webhook events from MailerCloud and other services
- Process events asynchronously using CloudAMQP (managed RabbitMQ)
- Store events in MongoDB Atlas for analysis
- Provide comprehensive monitoring with Prometheus and Grafana
- Scale horizontally with Docker containers and nginx load balancing

## 🛠️ Prerequisites

### Development Environment
- Docker Desktop (latest version)
- Docker Compose v2+
- Git
- Text editor (VS Code recommended)
- ngrok account (for webhook testing)

### Production Environment
- Ubuntu 20.04+ or CentOS 8+ server
- Docker and Docker Compose installed
- Domain name with DNS configured
- MongoDB Atlas account
- CloudAMQP account
- SSL certificate (auto-generated via Let's Encrypt)

### Cloud Services Required
- **MongoDB Atlas**: Database hosting
- **CloudAMQP**: Message queue hosting
- **ngrok**: Webhook testing (development only)

## 📋 Initial Setup

### 1. Clone Repository

```bash
git clone https://github.com/your-org/webhook-processor-prod.git
cd webhook-processor-prod
```

### 2. Generate Configuration

```bash
# Make script executable
chmod +x scripts/generate_secrets.sh

# Generate API keys and configuration template
./scripts/generate_secrets.sh
```

This creates:
- `.env.production` template with generated API keys
- Secure API keys for webhook authentication
- Configuration guidelines

### 3. Setup Cloud Services

#### MongoDB Atlas
1. Visit https://cloud.mongodb.com
2. Create new cluster (M0 free tier for testing)
3. Create database user with read/write permissions
4. Configure network access (0.0.0.0/0 for development)
5. Get connection string:
   ```
   mongodb+srv://username:password@cluster0.xxxxx.mongodb.net/?retryWrites=true&w=majority
   ```

#### CloudAMQP
1. Visit https://cloudamqp.com
2. Create new instance (Little Lemur for development)
3. Get AMQP URL from dashboard:
   ```
   amqps://username:password@host.cloudamqp.com/vhost
   ```

## 🚀 Development Setup

### 1. Configure Environment

```bash
# Copy example environment file
cp .env.example .env

# Edit .env with your cloud service credentials
nano .env
```

Update these key variables:
```bash
# MongoDB Atlas
MONGODB_URI=mongodb+srv://user:pass@cluster.mongodb.net/...

# CloudAMQP
CLOUDAMQP_URL=amqps://user:pass@instance.cloudamqp.com/vhost

# API Keys (generated by script)
MAILERCLOUD_API_KEY=your-generated-key

# ngrok token (get from https://ngrok.com)
NGROK_AUTHTOKEN=your-ngrok-token
```

### 2. Start Development Environment

#### Option A: With ngrok (recommended for webhook testing)
```bash
docker-compose -f docker-compose.dev.yml --profile ngrok up --build -d
```

#### Option B: Without ngrok (local development only)
```bash
docker-compose -f docker-compose.dev.yml up --build -d
```

### 3. Verify Development Setup

```bash
# Check all services are running
docker-compose -f docker-compose.dev.yml ps

# View logs
docker-compose -f docker-compose.dev.yml logs -f webhook-processor

# Test health endpoint
curl http://localhost:8080/health
```

### 4. Get Webhook URL

#### With ngrok:
1. Open ngrok dashboard: http://localhost:4040
2. Copy the HTTPS URL (e.g., `https://abc123.ngrok.io`)

#### Without ngrok:
Use your local IP: `http://your-local-ip:8080`

### 5. Development Endpoints

| Service | URL | Credentials |
|---------|-----|-------------|
| Webhook API | http://localhost:8080 | API key required |
| Health Check | http://localhost:8080/health | None |
| Metrics | http://localhost:9090 | None |
| Prometheus | http://localhost:9091 | None |
| Grafana | http://localhost:3000 | admin/admin |
| RabbitMQ Mgmt | http://localhost:15672 | guest/guest |
| MongoDB Express | http://localhost:8081 | None |
| ngrok Dashboard | http://localhost:4040 | None |

## 🏭 Production Deployment

### 1. Server Preparation

```bash
# Update system
sudo apt update && sudo apt upgrade -y

# Install Docker
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh
sudo usermod -aG docker $USER

# Install Docker Compose
sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose

# Logout and login to apply docker group membership
exit
```

### 2. Deploy Application

```bash
# Clone repository on server
git clone https://github.com/your-org/webhook-processor-prod.git
cd webhook-processor-prod

# Generate production configuration
./scripts/generate_secrets.sh

# Configure production environment
cp .env.example .env.production
nano .env.production
```

Update production variables:
```bash
# Application
APP_ENV=production
LOG_LEVEL=info

# Cloud services (use your actual credentials)
MONGODB_URI=mongodb+srv://produser:strongpass@prod-cluster.mongodb.net/...
CLOUDAMQP_URL=amqps://produser:strongpass@prod-instance.cloudamqp.com/vhost

# Domain configuration
DOMAIN=webhooks.yourcompany.com
LETSENCRYPT_EMAIL=admin@yourcompany.com

# Security
MAILERCLOUD_API_KEY=your-production-api-key

# Optional: Monitoring credentials
GRAFANA_PASSWORD=secure-password-here
```

### 3. Start Production Services

#### Option A: With monitoring (recommended)
```bash
docker-compose -f docker-compose.prod.yml --profile monitoring --env-file .env.production up -d
```

#### Option B: Without monitoring (minimal setup)
```bash
docker-compose -f docker-compose.prod.yml --env-file .env.production up -d
```

### 4. Verify Production Deployment

```bash
# Check service status
docker-compose -f docker-compose.prod.yml ps

# Monitor deployment
docker-compose -f docker-compose.prod.yml logs -f

# Test endpoints
curl https://your-domain.com/health
curl -H "X-API-Key: your-api-key" https://your-domain.com/webhook

# Check SSL certificate
curl -I https://your-domain.com
```

### 5. Production Endpoints

| Service | URL | Access |
|---------|-----|---------|
| Webhook API | https://your-domain.com | API key required |
| Health Check | https://your-domain.com/health | Public |
| Metrics | https://your-domain.com:9090/metrics | IP restricted |
| Grafana | https://your-domain.com:3001 | Admin credentials |
| Prometheus | https://your-domain.com:9091 | IP restricted |

## 🔧 MailerCloud Integration

### 1. Configure Webhook in MailerCloud

1. Login to MailerCloud dashboard
2. Navigate to "Integrations" → "Webhooks"
3. Click "Add New Webhook"
4. Configure:
   - **URL**: `https://your-domain.com/webhook`
   - **Method**: POST
   - **Headers**:
     ```
     X-API-Key: your-mailercloud-api-key
     Content-Type: application/json
     ```
   - **Events**: Select events to track (opens, clicks, bounces, etc.)

### 2. Test Webhook Integration

```bash
# Test webhook endpoint manually
curl -X POST https://your-domain.com/webhook \
  -H "Content-Type: application/json" \
  -H "X-API-Key: your-mailercloud-api-key" \
  -d '{
    "event": "email_opened",
    "email": "test@example.com",
    "campaign_id": "12345",
    "timestamp": 1641234567
  }'
```

Expected response:
```json
{
  "message": "Event accepted"
}
```

## 📊 Monitoring & Observability

### 1. Grafana Dashboards

Access Grafana at configured URL and import dashboards:

1. **Events Dashboard**:
   - Real-time event processing metrics
   - Success/failure rates
   - Processing latency

2. **Performance Dashboard**:
   - Request throughput
   - Response times
   - Resource utilization

3. **Error Dashboard**:
   - Error rates by client
   - Failed events
   - Retry statistics

### 2. Key Metrics to Monitor

- `webhook_events_received_total`: Total events received
- `webhook_events_processed_total`: Total events processed
- `webhook_processing_duration_seconds`: Processing time
- `webhook_queue_size`: Queue depth
- `webhook_retries_total`: Retry attempts
- `webhook_rate_limit_exceeded_total`: Rate limit violations

### 3. Alerting Setup

Configure alerts in Grafana:

1. **High Error Rate**: >5% error rate for 5 minutes
2. **Queue Backlog**: >1000 messages in queue
3. **Service Down**: Health check failures
4. **High Latency**: >1s average response time

## 🛠️ Maintenance Operations

### 1. Scaling

#### Horizontal Scaling
```bash
# Scale webhook processors
docker-compose -f docker-compose.prod.yml up -d --scale webhook-processor=3

# Scale workers
docker-compose -f docker-compose.prod.yml up -d --scale webhook-worker=5
```

#### Vertical Scaling
Update `docker-compose.prod.yml`:
```yaml
webhook-processor:
  deploy:
    resources:
      limits:
        cpus: '2.0'
        memory: 2G
```

### 2. Updates and Deployments

```bash
# Pull latest code
git pull origin main

# Rebuild and restart
docker-compose -f docker-compose.prod.yml build --no-cache
docker-compose -f docker-compose.prod.yml up -d

# Rolling update (zero downtime)
docker-compose -f docker-compose.prod.yml up -d --force-recreate --no-deps webhook-processor
```

### 3. Backup Operations

```bash
# Backup configuration
tar -czf backup-$(date +%Y%m%d).tar.gz .env.production nginx/ monitoring/

# MongoDB Atlas provides automatic backups
# Manual backup (if needed):
mongodump --uri="$MONGODB_URI" --out=backup-$(date +%Y%m%d)
```

### 4. Log Management

```bash
# View application logs
docker-compose logs -f webhook-processor

# View specific service logs
docker-compose logs -f webhook-worker

# Export logs for analysis
docker-compose logs --since 1h webhook-processor > app-logs.txt
```

## 🚨 Troubleshooting

### Common Issues and Solutions

1. **Database Connection Errors**:
   ```bash
   # Check MongoDB connectivity
   docker-compose exec webhook-processor wget -qO- http://localhost:9090/metrics | grep mongodb
   
   # Verify connection string format
   echo $MONGODB_URI
   ```

2. **Queue Connection Issues**:
   ```bash
   # Check RabbitMQ connectivity
   docker-compose logs webhook-processor | grep -i rabbitmq
   
   # Verify CloudAMQP status
   curl -u username:password https://api.cloudamqp.com/api/instances
   ```

3. **SSL Certificate Problems**:
   ```bash
   # Check certificate status
   docker-compose logs letsencrypt
   
   # Force renewal
   docker-compose exec letsencrypt certbot renew --force-renewal
   ```

4. **High Memory Usage**:
   ```bash
   # Check container resource usage
   docker stats
   
   # Restart services to clear memory
   docker-compose restart
   ```

5. **API Authentication Failures**:
   ```bash
   # Verify API key configuration
   docker-compose exec webhook-processor env | grep API_KEY
   
   # Check security middleware logs
   docker-compose logs webhook-processor | grep -i auth
   ```

### Health Check Commands

```bash
# Application health
curl -f http://localhost:8080/health || echo "API Down"

# Database health
docker-compose exec webhook-processor wget -qO- http://localhost:9090/metrics | grep mongodb_up

# Queue health
docker-compose exec webhook-processor wget -qO- http://localhost:9090/metrics | grep rabbitmq_up

# Overall system health
docker-compose ps | grep -v "Up"
```

### Performance Optimization

1. **Database Optimization**:
   - Enable MongoDB Atlas auto-scaling
   - Create appropriate indexes
   - Monitor slow queries in Atlas dashboard

2. **Queue Optimization**:
   - Upgrade CloudAMQP plan for higher throughput
   - Adjust worker concurrency
   - Monitor queue depth

3. **Application Optimization**:
   - Increase container resources
   - Adjust rate limits based on traffic
   - Enable HTTP/2 in nginx

## 📞 Support and Resources

### Getting Help

1. **Check Documentation**: Review README.md and CONFIG.md
2. **View Logs**: Use docker-compose logs for debugging
3. **Monitor Metrics**: Check Grafana dashboards
4. **Community Support**: Create issues in repository

### Useful Resources

- **MongoDB Atlas**: https://docs.atlas.mongodb.com/
- **CloudAMQP**: https://www.cloudamqp.com/docs/
- **Docker Compose**: https://docs.docker.com/compose/
- **Let's Encrypt**: https://letsencrypt.org/docs/
- **Prometheus**: https://prometheus.io/docs/
- **Grafana**: https://grafana.com/docs/

### Emergency Procedures

#### Service Outage
```bash
# Quick restart all services
docker-compose -f docker-compose.prod.yml restart

# Check for resource issues
df -h && free -h && docker system df
```

#### Database Issues
```bash
# Switch to backup connection (if configured)
export MONGODB_URI=$MONGODB_BACKUP_URI
docker-compose restart webhook-processor
```

#### Certificate Expiry
```bash
# Manual certificate renewal
docker-compose exec letsencrypt certbot renew --force-renewal
docker-compose restart nginx-proxy
```

## 🎉 Conclusion

You now have a fully functional webhook processing system that can:
- Handle webhook events from MailerCloud and other providers
- Scale horizontally with container orchestration
- Monitor performance with comprehensive metrics
- Maintain high availability with cloud services
- Secure communications with SSL/TLS

For ongoing support, monitor the Grafana dashboards, review application logs regularly, and keep cloud services updated with the latest features and security patches.
